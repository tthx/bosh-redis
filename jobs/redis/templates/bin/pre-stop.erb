#!/bin/bash
<%- sentinel=nil
  if_link('redis_sentinel_conn'){ |x| sentinel=x }
  sentinel_slave=nil
  if_link('sentinel_slave_conn'){ |x| sentinel_slave=x } -%>

ERR=0;

<%- if !sentinel.nil? -%>
if [[ ${BOSH_DEPLOYMENT_NEXT_STATE} == "delete" ]];
then
  CLI="/var/vcap/packages/redis/bin/redis-cli";
  SENTINEL_PORT="<%= sentinel.p('port') %>";
  SENTINEL_CRED="";
  <%- sentinel.if_p('password') do |x|
      unless x.to_s.empty? -%>
  SENTINEL_CRED="-a <%= x %>";
  <%- end
    end 
    if sentinel.p('tls') -%>
  SENTINEL_PORT="<%= sentinel.p('tls_port') %>";
  SENTINEL_CRED+=" --tls --cert ${TLS_CERT_FILE}";
  SENTINEL_CRED+=" --key ${TLS_KEY_FILE}";
  SENTINEL_CRED+=" --cacert ${TLS_CA_CERT_FILE}";
  <%- end
    sentinel_addresses=''
    sentinel.instances.each{ |x| sentinel_addresses.concat(x.address).concat(' ') }
    if !sentinel_slave.nil?
      sentinel_slave.instances.each{ |x| sentinel_addresses.concat(x.address).concat(' ') }
    end -%>
  SENTINEL_ADDRESSES="<%= sentinel_addresses %>";

  for x in ${SENTINEL_ADDRESSES};
  do
    MSG="$("${CLI}" \
      -h "${x}" \
      -p "${SENTINEL_PORT}" \
      ${SENTINEL_CRED} \
      SENTINEL REMOVE <%= spec.deployment %>)";
    if [[ ${?} -eq 0 ]];
    then
      echo "Sentinel [${x}] removed [<%= spec.deployment %>] from monitor.";
    else
      ERR=1;
      echo "ERROR: Unable to removed [<%= spec.deployment %>] from Sentinel [${x}]: \"${MSG}\"." >&2;
    fi
  done
fi
<%- end -%>

exit ${ERR};