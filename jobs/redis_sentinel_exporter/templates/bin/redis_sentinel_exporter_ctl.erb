#!/usr/bin/env bash
<%- sentinel=link('redis_sentinel_conn') -%>

set -eu

PROGNAME="redis_sentinel_exporter";
RUN_DIR="/var/vcap/sys/run/${PROGNAME}";
LOG_DIR="/var/vcap/sys/log/${PROGNAME}";
TMP_DIR="/var/vcap/sys/tmp/${PROGNAME}";
STORE_DIR="/var/vcap/sys/store/${PROGNAME}";
PID_FILE="${RUN_DIR}/${PROGNAME}.pid";
mkdir -p "${RUN_DIR}" "${LOG_DIR}" "${TMP_DIR}" "${STORE_DIR}";
chown vcap:vcap "${RUN_DIR}" "${LOG_DIR}" "${TMP_DIR}" "${STORE_DIR}";

IP="127.0.0.1";
<%- if sentinel.p('bind') -%>
IP="<%= spec.ip %>";
<%- end -%>
ARGS="-sentinel.addr redis://${IP}:<%= sentinel.p('port') %>";
<%- sentinel.if_p('password') do |x|
    unless x.to_s.empty? -%>
ARGS+=" -sentinel.password <%= x %>";
<%- end
  end -%>
<%- if p('debug') -%>
ARGS+=" -debug";
<%- end -%>

source "/var/vcap/packages/${PROGNAME}/bin/utils.sh";
exec 1>> "${LOG_DIR}/${PROGNAME}.stdout.log";
exec 2>> "${LOG_DIR}/${PROGNAME}.stderr.log";
chown vcap:vcap \
  "${LOG_DIR}/${PROGNAME}.stdout.log" \
  "${LOG_DIR}/${PROGNAME}.stderr.log";

export PATH="/var/vcap/packages/${PROGNAME}/bin:${PATH}";

case $1 in
  start)
    pid_guard "${PID_FILE}" "${PROGNAME}";
    echo $$ > "${PID_FILE}";

    exec chpst -u vcap:vcap "${PROGNAME}" \
      ${ARGS} \
      -log-format <%= p('log_format') %> \
      -namespace <%= p('namespace') %> \
      -web.listen-address <%= spec.ip+':'+p('web.port') %> \
      -web.telemetry-path <%= p('web.telemetry_path') %> \
      >> "${LOG_DIR}/${PROGNAME}.stdout.log" \
      2>> "${LOG_DIR}/${PROGNAME}.stderr.log";
    ;;

  stop)
    kill_and_wait "${PID_FILE}";
    ;;

  *)
    echo "Usage: $0 {start|stop}";
    exit 1;
    ;;

esac
exit 0;
